<html>
<head>
 <meta charset="utf-8">
 <style>
  h1 {
   color: #80f;
  }
  li {
   line-height: 200%;
  }
  a{
   background: #c9f;
   color: #638;
   text-decoration: none;
   padding: 3px;
   border-radius: 8px;
  }
  button,
  input,
  textarea {
   font-size: inherit;
   border-radius: 8px;
   padding: 3px;
   white-space: pre-wrap;
  }
  fieldset {
   border-radius: 20px;
   background: #edf;
  }
  textarea {
   width: calc(50% - 8px);
   height: 250px;
  }
 </style>
</head>
<body>
 <h1>欢迎使用TabletHack系统！</h1>
 <fieldset>
  <legend>
   书签
   <button id="editModeBtn" onclick="editMode = !editMode; update()">管理...</button>
  </legend>
  <ul id="table"></ul>
 </fieldset>
 <fieldset>
  <legend>前往</legend>
  <input id="input" placeholder="网址" value="https://">
  <button onclick="myopen(input.value)">前往</button>
  <input id="ninput" placeholder="书签名称">
  <button onclick="if (ninput.value) bookmarks.push([ninput.value, input.value]); update()">创建书签</button>
 </fieldset>
 <fieldset>
  <legend>
   调试框
   <button onclick="codebox.value=`bookmarks=\`\n\n${bookmarks.map(v=>v.map(c=>c.replace(/([`\\])/g,'\\$1')).join(' | ')).join('\n\n')}\n\n\`.trim().split(/\\n+/).map(l=>l.trim().split(' | ').map(c=>c.trim())),update(),value='','success'`">编辑所有书签</button>
   <button onclick="location.reload()">刷新TabletHack系统</button>
  </legend>
  <textarea id="codebox" onblur="try { let r = eval(this.value); out.value = r } catch (e) { out.value=e }" placeholder="调试框"></textarea>
  <textarea readonly placeholder="返回值" id="out"></textarea>
 </fieldset>
 <script>
  alert = prompt = confirm = () => { throw new Error('来自TabletHack系统的提示：由于浏览器限制，不能弹出对话框'); };
  var bookmarks = [['百度', 'https://www.baidu.com']];
  var b = /bookmarks=([^;]+)/g.exec(document.cookie);
  b = b ? b[1] : undefined;
  if (b)
   bookmarks = decodeURIComponent(b).split('&').map(i => i.split('=').map(ii => decodeURIComponent(ii)));
  function myopen(url) {
    document.cookie = "hist=" + encodeURIComponent(url) + "; expires=Fri Dec 31 9999 23:59:59; path=/tablethack;";
    open(url);
  }
  var h = /hist=([^;]+)/g.exec(document.cookie);
  if (h)
    input.value = decodeURIComponent(h[1]);
  function update() {
   editModeBtn.firstChild.nodeValue = editMode ? '完成' : '管理...';
   [...table.children].forEach(e => e.remove());
   bookmarks.map((v, i) => {
    var name = v[0] || "", url = v[1] || "";
    var li = document.createElement('li');
    li.appendChild(document.createElement('span')).innerHTML = name;
    li.appendChild(document.createTextNode(' '));
    var a = li.appendChild(document.createElement('a'));
    a.href = url;
    a.appendChild(document.createTextNode(url.length>92?url.substr(0,90)+"...":url));
    li.appendChild(document.createTextNode(' '));
    var button = li.appendChild(document.createElement('button'));
    if (editMode) {
     button.appendChild(document.createTextNode('删除'));
     button.onclick = () => {
      bookmarks.splice(i, 1);
      editMode = false;
      update();
     };
    }
    else {
     button.appendChild(document.createTextNode('  ↓  '));
     button.onclick = () => {
      input.value = v[1];
      ninput.value = v[0];
     };
    }
    table.appendChild(li);
   });
   document.cookie = "bookmarks=" + encodeURIComponent(bookmarks.map(
    v => v.map(vv => encodeURIComponent(vv)).join('=')).join('&')
   ) + "; expires=Fri Dec 31 9999 23:59:59; path=/tablethack;";
  }
  update();
  var editMode = false;
 </script>
</body>
</html>
